{
  "variables": {
    "template": "win2008r2-std-2updates",
    "headless": "false",
    "box_basename": "windows-2008r2",
    "build_timestamp": "{{isotime \"20060102150405\"}}"
  },
  "builders": [
    {
      "type": "vmware-vmx",
      "source_path": "D:/PACKER_BUILDS/packer-win2008r2-std-1base-vmware/packer-win2008r2-std-1base-vmware.vmx",
      "output_directory": "D:/PACKER_BUILDS/packer-{{user `template`}}-vmware",
      "communicator": "winrm",
      "winrm_username": "vagrant",
      "winrm_password": "vagrant",
      "winrm_timeout": "12h",
      "vm_name": "packer-{{user `template`}}-vmware",
      "headless": "{{user `headless`}}",
      "shutdown_command": "shutdown /s /t 10 /f /d p:4:1 /c \"Packer Shutdown\"",
      "shutdown_timeout": "15m",
      "vmx_remove_ethernet_interfaces": false
    }
  ],
  "provisioners": [
    {
      "type": "powershell",
      "elevated_user": "vagrant",
      "elevated_password": "vagrant",
      "valid_exit_codes": [
        0,
        1605,
        1614,
        1641,
        3010
      ],
      "inline": [
        "Set-ExecutionPolicy Bypass -Scope Process -Force; iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))"
      ]
    },
    {
      "type": "powershell",
      "elevated_user": "vagrant",
      "elevated_password": "vagrant",
      "valid_exit_codes": [
        0,
        1605,
        1614,
        1641,
        3010
      ],
      "inline": [
        "#choco config  set     --name='proxy'         --value=''",
        "#choco config  set     --name='proxyUser'     --value=''",
        "#choco config  set     --name='proxyPassword' --value=''",
        "choco feature enable  --name='usePackageExitCodes'",
        "choco feature enable  --name='useRememberedArgumentsForUpgrades'",
        "choco feature enable  --name='stopOnFirstPackageFailure'",
        "choco feature enable  --name='logWithoutColor'"
      ]
    },
    {
      "type": "windows-restart"
    },
    {
      "type": "powershell",
      "elevated_user": "vagrant",
      "elevated_password": "vagrant",
      "valid_exit_codes": [
        0,
        1605,
        1614,
        1641,
        3010
      ],
      "inline": [
        "choco upgrade 7zip --acceptlicense --yes --no-progress",
        "choco upgrade choco-shortcuts-winconfig --acceptlicense --yes --no-progress",
        "choco upgrade choco-cleaner --acceptlicense --yes --no-progress",
        "choco upgrade flashplayerplugin-disable-updates-winconfig --acceptlicense --yes --no-progress",
        "choco upgrade sysinternals --acceptlicense --yes --no-progress",
        "choco upgrade ultradefrag --acceptlicense --yes --no-progress",
        "choco upgrade vmware-tools --acceptlicense --yes --no-progress"
      ]
    },
    {
      "type": "windows-restart"
    },
    {
      "type": "powershell",
      "elevated_user": "vagrant",
      "elevated_password": "vagrant",
      "valid_exit_codes": [
        0,
        1605,
        1614,
        1641,
        3010
      ],
      "inline": [
        "choco upgrade kb976932 --acceptlicense --yes --no-progress"
      ]
    },
    {
      "type": "windows-restart"
    },
    {
      "type": "powershell",
      "elevated_user": "vagrant",
      "elevated_password": "vagrant",
      "valid_exit_codes": [
        0,
        1605,
        1614,
        1641,
        3010
      ],
      "inline": [
        "choco upgrade kb3035131 --acceptlicense --yes --no-progress"
      ]
    },
    {
      "type": "windows-restart"
    },
    {
      "type": "powershell",
      "elevated_user": "vagrant",
      "elevated_password": "vagrant",
      "valid_exit_codes": [
        0,
        1605,
        1614,
        1641,
        3010
      ],
      "inline": [
        "choco upgrade kb3033929 --acceptlicense --yes --no-progress"
      ]
    },
    {
      "type": "windows-restart"
    },    {
      "type": "windows-shell",
      "inline": [
        "wusa.exe ./kb/Windows6.1-KB2852386-v2-x64.msu /quiet"
      ]
    },
    {
      "type": "windows-restart"
    },
    {
      "type": "powershell",
      "elevated_user": "vagrant",
      "elevated_password": "vagrant",
      "valid_exit_codes": [
        0,
        1605,
        1614,
        1641,
        3010
      ],
      "inline": [
        "choco install   NetFx3                        --source='WindowsFeatures'",
        "choco uninstall MicrosoftWindowsPowerShellISE --source='WindowsFeatures'"
      ]
    },
    {
      "type": "windows-restart"
    },
    {
      "type": "powershell",
      "elevated_user": "vagrant",
      "elevated_password": "vagrant",
      "valid_exit_codes": [
        0,
        1605,
        1614,
        1641,
        3010
      ],
      "inline": [
        "choco upgrade dotnetfx --version 4.5.2.0 --acceptlicense --yes --no-progress"
      ]
    },
    {
      "type": "windows-restart"
    },
    {
      "type": "powershell",
      "elevated_user": "vagrant",
      "elevated_password": "vagrant",
      "valid_exit_codes": [
        0,
        1605,
        1614,
        1641,
        3010
      ],
      "inline": [
        "choco upgrade powershell --version 4.0.20141001 --acceptlicense --yes --no-progress"
      ]
    },
    {
      "type": "windows-restart"
    },
    {
      "type": "powershell",
      "elevated_user": "vagrant",
      "elevated_password": "vagrant",
      "valid_exit_codes": [
        0,
        1605,
        1614,
        1641,
        3010
      ],
      "inline": [
        "choco upgrade powershell --acceptlicense --yes --no-progress"
      ]
    },
    {
      "type": "windows-restart"
    },
    {
      "type": "windows-update",
      "search_criteria": "AutoSelectOnWebSites=1 and IsInstalled=0",
      "filters": [
        "exclude:$_.Title -like '*Preview*'",
        "include:$true"
      ]
    },
    {
      "type": "windows-restart"
    }
  ],
  "post-processors": [
    {
      "type": "compress",
      "output": "D:/VAGRANT_BOXES/{{user `template`}}-vmware.zip",
      "compression_level": 9,
      "keep_input_artifact": true
    }
  ]
}