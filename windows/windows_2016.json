{
  "variables": {
    "mirror": "http://download.microsoft.com/download",
    "mirror_directory": "pr",
    "iso_name": "Windows_Server_2016_Datacenter_EVAL_en-us_14393_refresh.ISO",
    "iso_checksum": "772700802951b36c8cb26a61c040b9a8dc3816a3",
    "iso_checksum_type": "sha1",

		"template": "windows-2016-standard",

    "headless": "false",
    "box_basename": "windows-2016",
    "build_timestamp": "{{isotime \"20060102150405\"}}",

    "cpus": "2",
    "memory": "4096",
    "disk_size": "65536",

    "floppy_files": "answer_files/2016/Autounattend.xml"

  },
  "builders": [
    { "type": "vmware-iso",
      "name": "{{user `box_basename`}}",
      "communicator": "winrm",
        "winrm_username": "vagrant",
        "winrm_password": "vagrant",
        "winrm_timeout": "12h",
  
        "iso_url":            "{{user `mirror`}}/{{user `mirror_directory`}}/{{user `iso_name`}}",
        "iso_checksum":       "{{user `iso_checksum`}}",
        "iso_checksum_type":  "{{user `iso_checksum_type`}}",
        "output_directory":   "../builds/packer-{{user `template`}}-vmware",

        "vm_name":  "packer-{{user `template`}}-vmware",
        "headless": "{{user `headless`}}",

        "guest_os_type": "windows9srv-64",
        "cpus":           "{{user `cpus` }}",
        "cores":          1,
        "memory":         "{{user `memory` }}",
        "disk_size":      "{{user `disk_size`}}",
        "disk_adapter_type": "lsisas1068",
        "disk_type_id":   "4",
        "parallel": "NONE",
        "serial": "NONE",
        "sound": false,
        "usb": false,

        "floppy_files": "{{user `floppy_files`}}",
  
        "shutdown_command": "shutdown /s /t 10 /f /d p:4:1 /c \"Packer Shutdown\"",
        "shutdown_timeout": "15m",
        "vmx_remove_ethernet_interfaces": true
    }
  ],

  "provisioners": [
    { "type": "powershell",
      "elevated_user": "vagrant",
      "elevated_password": "vagrant",
      "valid_exit_codes": [0, 1605, 1614, 1641, 3010],
      "inline": ["Set-ExecutionPolicy Bypass -Scope Process -Force; iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))"]
    },
    { "type": "powershell",
      "elevated_user": "vagrant",
      "elevated_password": "vagrant",
      "valid_exit_codes": [0, 1605, 1614, 1641, 3010],
      "inline": [ 
        "#choco config  set     --name='proxy'         --value=''",
        "#choco config  set     --name='proxyUser'     --value=''",
        "#choco config  set     --name='proxyPassword' --value=''",
        "choco feature enable  --name='usePackageExitCodes'",
        "choco feature enable  --name='useRememberedArgumentsForUpgrades'",
        "choco feature enable  --name='stopOnFirstPackageFailure'",
        "choco feature enable  --name='logWithoutColor'"
      ]
    },
    { "type": "windows-restart" },
    { "type": "powershell",
      "elevated_user": "vagrant",
      "elevated_password": "vagrant",
      "valid_exit_codes": [0, 1605, 1614, 1641, 3010],
      "inline": [ 
        "choco upgrade vmware-tools --acceptlicense --yes --no-progress",
        "choco upgrade 7zip         --acceptlicense --yes --no-progress"      ]
    },
    { "type": "windows-restart" },
    { "type": "powershell",
      "elevated_user": "vagrant",
      "elevated_password": "vagrant",
      "valid_exit_codes": [0, 1605, 1614, 1641, 3010],
      "inline": [ 
        "choco install NetFx3               --source='WindowsFeatures'",
        "choco install NetFx3ServerFeatures --source='WindowsFeatures'",
        "choco uninstall MicrosoftWindowsPowerShellISE --source='WindowsFeatures'"
      ]
    },
    { "type": "windows-restart" },
    { "type": "powershell",
      "elevated_user": "vagrant",
      "elevated_password": "vagrant",
      "valid_exit_codes": [0, 1605, 1614, 1641, 3010],
      "inline": [ "choco upgrade dotnetfx --acceptlicense --yes --no-progress" ]
    },
    { "type": "windows-restart" },
    { "type": "powershell",
      "elevated_user": "vagrant",
      "elevated_password": "vagrant",
      "valid_exit_codes": [0, 1605, 1614, 1641, 3010],
      "inline": [ "choco upgrade powershell --acceptlicense --yes --no-progress" ]
    },
    { "type": "windows-restart" },
    { "type": "chef-solo",
      "guest_os_type": "windows",
      "cookbook_paths": ["cookbooks"],
      "run_list": [
          "packer::disable_uac",
          "packer::disable_restore",
          "packer::disable_windows_update",
          "packer::remove_defender"
      ]
    },
    { "type": "windows-restart" },
    { "type": "chef-solo",
      "guest_os_type": "windows",
      "cookbook_paths": ["cookbooks"],
      "run_list": [
          "packer::enable_file_sharing",
          "packer::enable_remote_desktop",
          "packer::ui_tweaks",
          "packer::power"
      ]
    },
    { "type": "windows-restart" },
    { "type": "windows-update",
      "search_criteria": "AutoSelectOnWebSites=1 and IsInstalled=0",
      "filters": [ "exclude:$_.Title -like '*Preview*'", "include:$true" ]
    },
    { "type": "windows-restart" },
    { "type": "chef-solo",
      "guest_os_type": "windows",
      "cookbook_paths": ["cookbooks"],
      "run_list": [
        "packer::disable_uac",
        "packer::disable_windows_update",
        "packer::cleanup",
        "packer::defrag"
      ]
    },
    { "type": "powershell",
      "elevated_user": "vagrant",
      "elevated_password": "vagrant",
      "valid_exit_codes": [0, 1605, 1614, 1641, 3010],
      "script": "scripts/cleanup.ps1"
    }
],

  "post-processors": [  { "type": "vagrant-vmware-ovf"  } ]
}
